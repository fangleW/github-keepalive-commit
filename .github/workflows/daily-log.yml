# .github/workflows/daily-log.yml
name: Monthly Log

on:
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  daily-log:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Environment
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Create Monthly Log
        run: |
          # è®¾ç½®æ—¶åŒº
          export TZ='Asia/Shanghai'
          
          DATE=$(date '+%Y-%m-%d')
          YEAR=$(date '+%Y')
          MONTH=$(date '+%m')
          MONTH_NAME=$(date '+%Y-%m')
          DAY_OF_YEAR=$(date '+%j')
          WEEK=$(date '+%V')
          WEEKDAY=$(date '+%A')
          
          # åˆ›å»ºç›®å½•ç»“æ„
          mkdir -p "logs/$YEAR"
          
          # æœˆåº¦æ—¥å¿—æ–‡ä»¶è·¯å¾„
          LOG_FILE="logs/$YEAR/$MONTH_NAME.md"
          
          # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºå¸¦æœ‰æ ‡é¢˜çš„æ–°æ–‡ä»¶
          if [ ! -f "$LOG_FILE" ]; then
            cat > "$LOG_FILE" << EOF
          # ğŸ“… $MONTH_NAME æœˆåº¦è®°å½•
          
          > æœ¬æ–‡æ¡£è®°å½• $MONTH_NAME çš„æ—¥å¸¸æ›´æ–°
          
          ---
          
          EOF
          fi
          
          # åŠ±å¿—è¯­å½•æ•°ç»„
          QUOTES=(
            "ğŸ’ª æ¯ä¸€å¤©éƒ½æ˜¯æ–°çš„å¼€å§‹ï¼ŒåŠ æ²¹ï¼"
            "ğŸŒŸ æˆåŠŸæºäºæ¯ä¸€å¤©çš„ç§¯ç´¯ä¸åšæŒã€‚"
            "ğŸš€ ä»Šå¤©çš„åŠªåŠ›ï¼Œæ˜¯ä¸ºäº†æ›´å¥½çš„æ˜å¤©ã€‚"
            "âœ¨ ç›¸ä¿¡è‡ªå·±ï¼Œä½ æ¯”æƒ³è±¡ä¸­æ›´å¼ºå¤§ã€‚"
            "ğŸŒˆ å›°éš¾åªæ˜¯æš‚æ—¶çš„ï¼ŒåšæŒå°±æ˜¯èƒœåˆ©ã€‚"
            "ğŸ¯ ä¸“æ³¨å½“ä¸‹ï¼Œå…¨åŠ›ä»¥èµ´ã€‚"
            "ğŸ’ æ¯ä¸€æ¬¡åŠªåŠ›éƒ½ä¸ä¼šè¢«è¾œè´Ÿã€‚"
            "ğŸŒ¸ ä¿æŒçƒ­çˆ±ï¼Œå¥”èµ´å±±æµ·ã€‚"
            "â­ è¡ŒåŠ¨æ˜¯æ²»æ„ˆææƒ§çš„è‰¯è¯ã€‚"
            "ğŸ”¥ ä½ çš„åšæŒï¼Œç»ˆå°†ç¾å¥½ã€‚"
            "ğŸŒ» ç§ä¸€æ£µæ ‘æœ€å¥½çš„æ—¶é—´æ˜¯åå¹´å‰ï¼Œå…¶æ¬¡æ˜¯ç°åœ¨ã€‚"
            "ğŸˆ ä¸è¦ç­‰å¾…æœºä¼šï¼Œè€Œè¦åˆ›é€ æœºä¼šã€‚"
            "ğŸŒº æˆåŠŸä¸æ˜¯å¶ç„¶ï¼Œè€Œæ˜¯å¿…ç„¶ã€‚"
            "ğŸ† ä»Šæ—¥äº‹ä»Šæ—¥æ¯•ï¼Œæ˜å¤©ä¼šæ›´å¥½ã€‚"
            "ğŸ’« ä¿æŒè¿›æ­¥ï¼Œæ°¸ä¸æ­¢æ­¥ã€‚"
            "ğŸŒ™ æ˜Ÿå…‰ä¸é—®èµ¶è·¯äººï¼Œæ—¶å…‰ä¸è´Ÿæœ‰å¿ƒäººã€‚"
            "ğŸ¨ ç”Ÿæ´»æ˜¯è‡ªå·±åˆ›é€ çš„ç”»å¸ƒã€‚"
            "ğŸ“š å­¦ä¹ æ˜¯ä¸€ç”Ÿçš„è´¢å¯Œã€‚"
            "ğŸŒŠ ä¸ç§¯è·¬æ­¥ï¼Œæ— ä»¥è‡³åƒé‡Œã€‚"
            "ğŸµ çƒ­çˆ±ç”Ÿæ´»ï¼Œäº«å—å½“ä¸‹ã€‚"
          )
          
          # æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²ç»æ‰“å¡
          if grep -q "## ğŸ“ $DATE" "$LOG_FILE"; then
            echo "âœ… ä»Šæ—¥ ($DATE) å·²ç»æ‰“å¡è¿‡äº†ï¼Œè·³è¿‡é‡å¤è®°å½•"
          else
            echo "ğŸ“ å¼€å§‹è®°å½•ä»Šæ—¥ ($DATE) çš„æ‰“å¡ä¿¡æ¯..."
            
            # éšæœºé€‰æ‹©ä¸€æ¡è¯­å½•ï¼ˆä½¿ç”¨æ—¥æœŸä½œä¸ºéšæœºç§å­ï¼Œç¡®ä¿æ¯å¤©ä¸åŒï¼‰
            RANDOM_INDEX=$((10#$(date '+%d') % ${#QUOTES[@]}))
            DAILY_QUOTE="${QUOTES[$RANDOM_INDEX]}"
            
            # è¿½åŠ ä»Šæ—¥è®°å½•
            cat >> "$LOG_FILE" << EOF
          ## ğŸ“ $DATE ($WEEKDAY)
          
          - ğŸ—“ï¸ ä»Šå¹´ç¬¬ $DAY_OF_YEAR å¤©
          - ğŸ“… ç¬¬ $WEEK å‘¨
          - â° æ›´æ–°æ—¶é—´: $(date '+%H:%M:%S')
          
          ### ğŸ’¬ ä»Šæ—¥å¯„è¯­
          > $DAILY_QUOTE
          
          ---
          
          EOF
            echo "âœ¨ ä»Šæ—¥æ‰“å¡å®Œæˆï¼"
          fi
          
          # æ›´æ–° README ä¸­çš„æœ€åæ‰“å¡æ—¶é—´ï¼ˆä¿ç•™å…¶ä»–å†…å®¹ï¼‰
          if [ -f "README.md" ]; then
            # åˆ é™¤æ—§çš„æ‰“å¡æ—¶é—´æ ‡è®°è¡Œï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            sed -i.bak '/<!-- AUTO_CHECKIN_START -->/,/<!-- AUTO_CHECKIN_END -->/d' README.md
            rm -f README.md.bak
          else
            # å¦‚æœ README ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªç®€å•çš„
            echo "# Daily Log" > README.md
            echo "" >> README.md
          fi
          
          # åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ æ–°çš„æ‰“å¡æ—¶é—´æ ‡è®°
          cat >> README.md << EOF
          
          <!-- AUTO_CHECKIN_START -->
          **ğŸ“… æœ€åæ‰“å¡æ—¶é—´**: $DATE $(date '+%H:%M:%S')
          <!-- AUTO_CHECKIN_END -->
          EOF

      - name: Commit and Push
        run: |
          git add -A
          git diff-index --quiet HEAD || git commit -m "ğŸ“ Monthly log update: $(date '+%Y-%m-%d')"
          git push
